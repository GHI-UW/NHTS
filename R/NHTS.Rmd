# NHTS 2017

```{r libs, eval = TRUE, echo = FALSE, results = "hide", warning = FALSE, error = FALSE, message = FALSE, fig.width = 8}
rm(list=ls())
library("tidyverse")
library("xtable")
#library("devtools")
#install("~/ITHIM/")
#library("ITHIM")
opts_knit$set(root.dir = "~/NHTS/")
RDS <- FALSE
```
## Load Trip Data
```{r trippub, eval = !RDS, echo = !RDS, results = "show", warning = FALSE, error = FALSE, message = FALSE, results="asis"}

trippub <- read.csv(file = "./data/trippub.csv")

trippub <- with(trippub,{
    data.frame(HOUSEID = HOUSEID,
               PERSONID = PERSONID,
               TDCASEID = TDCASEID,
               TRPTRANS = factor(ifelse(TRPTRANS %in% c(-9,-8,-7,97), NA, TRPTRANS), levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20), labels = c("walk","cycle","car","SUV","van","pickup truck","golf cart/Segway","motorcycle/moped","RV","school bus","public or commuter bus","paratransit/Dial-a-ride","private/charter/tour/shuttle bus","city-to-city bus (Greyhound, Megabus)","Amtrak/commuter rail","subway/elevated/light rail/street car","taxi/limo/Uber/Lyft", "rental car/Zipcar/Car2Go", "airplane","boat/ferry/water taxi")),
               TRVLCMIN = as.numeric(TRVLCMIN),
               URBRUR  = as.factor(URBRUR),
               MSACAT = as.factor(MSACAT),
               MSA = ifelse(MSASIZE %in% 1:5, TRUE, FALSE),
               TRPMILES = as.numeric(TRPMILES)
)})

trippub <- with(trippub,{
    data.frame(houseID=HOUSEID, subjectID=PERSONID, duration = TRVLCMIN, mode = TRPTRANS)
})
```

## Load Person Data
```{r perpub, eval = !RDS, echo = !RDS, results = "show", warning = FALSE, error = FALSE, message = FALSE, results="asis"}
perpub <- read.csv(file = "./data/perpub.csv")
perpub <- with(perpub,{
                    data.frame(HOUSEID = HOUSEID,
                               PERSONID = PERSONID,
                               SEX = as.factor(ifelse(R_SEX=="1", "M", ifelse(R_SEX=="2", "F", NA))),
                               AGE = as.numeric(R_AGE),
                               # AGE = as.factor(ITHIM:::convertToAgeClass(R_AGE)),
                               MSA = ifelse(MSASIZE %in% 1:5, TRUE, FALSE),
                               HHSTATE = as.character(HHSTATE),
                               # HHS = as.character(convertToHHS(as.character(HHSTATE))),
                               # MSA_ID = as.character(as.integer(HHC_MSA)), stringsAsFactors = FALSE,
                               HHFAMINC = as.factor(HHFAMINC),
                               #NWALKTRP = as.numeric(if(NWALKTRP < 0, NA, NWALKTRP)),
                               #NBIKETRP = as.numeric(if(NBIKETRP < 0, NA, NBIKETRP)))
                               NWALKTRP = NWALKTRP,
                               NBIKETRP = NBIKETRP)
})

perpub <- with(perpub,{
    data.frame(houseID=HOUSEID, subjectID=PERSONID, sex = SEX, age = AGE, location = HHSTATE, income = HHFAMINC, nwalktrp = NWALKTRP, nbiketrp = NBIKETRP)
    })
```

## Load Household Data
```{r hhpub, eval = !RDS, echo = !RDS, results = "show", warning = FALSE, error = FALSE, message = FALSE, results="asis"}
hhpub <- read.csv(file = "./data/hhpub.csv")
hhpub <- with(hhpub,{
                    data.frame(HOUSEID = factor(HOUSEID),
                               BIKE = factor(ifelse(BIKE %in% c(-9,-8,-7), NA, BIKE), levels = 1:5, labels = c("daily","a few times a week","a few times a month","a few times a year","never")),
                               WALK = factor(ifelse(WALK %in% c(-9,-8,-7), NA, WALK), levels = 1:5, labels = c("daily","a few times a week","a few times a month","a few times a year","never")),
                               CAR = factor(ifelse(CAR %in% c(-9,-8,-7), NA, CAR), levels = 1:5, labels = c("daily","a few times a week","a few times a month","a few times a year","never")),
                               BUS = factor(ifelse(BUS %in% c(-9,-8,-7), NA, BUS), levels = 1:5, labels = c("daily","a few times a week","a few times a month","a few times a year","never")),
                               TAXI = factor(ifelse(TAXI %in% c(-9,-8,-7), NA, TAXI), levels = 1:5, labels = c("daily","a few times a week","a few times a month","a few times a year","never")),
                               TRAIN = factor(ifelse(TRAIN %in% c(-9,-8,-7), NA, TRAIN), levels = 1:5, labels = c("daily","a few times a week","a few times a month","a few times a year","never")),
                               PARA = factor(ifelse(PARA %in% c(-9,-8,-7), NA, PARA), levels = 1:5, labels = c("daily","a few times a week","a few times a month","a few times a year","never")),
                               URBRUR = factor(URBRUR, levels = 1:2, labels = c("urban","rural")),
                               HH_CBSA = factor(ifelse(HH_CBSA == "XXXXX", NA, as.character(HH_CBSA)))
                               )
})

cbsaNames <- read.csv(file = "./data/cbsa2fipsxw.csv")
cbsaNames <- cbsaNames %>% filter(!is.na(cbsacode)) %>% group_by(cbsacode) %>% summarise(cbsatitle = first(cbsatitle))

hhpub <- within(hhpub, {
    HH_CBSA <- factor(HH_CBSA, levels = cbsaNames$cbsacode, labels = cbsaNames$cbsatitle)
})
```

## Join Person and Trip Data
```{r join, eval = !RDS, echo = !RDS, results = "show", warning = FALSE, error = FALSE, message = FALSE, results="asis"}
NHTS.df <- dplyr::left_join(perpub, trippub, by = c("houseID","subjectID"))

NHTS.df <- within(NHTS.df, {
    id <- paste0(houseID,"-",subjectID)
    duration <- ifelse(is.na(duration), 0, duration)
    mode <- mode
    location <- location
})

saveRDS(NHTS.list <- list(perpub = perpub, trippub = trippub, hhpub = hhpub, NHTS.df = NHTS.df), file = "./R/data/NHTS.list.rds")
```

## Read saved R data object (rds)
```{r readRDS, eval = RDS, echo = RDS, results = "show", warning = FALSE, error = FALSE, message = FALSE, results="asis"}
NHTS.list <- readRDS(file = "./R/data/NHTS.list.rds")
```

## Summary Statistics

### Person Data
```{r summaryPerpub, eval = FALSE, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, results="asis", fig.width = 8}
NHTS.list$perpub %>% group_by(location) %>% summarise(n = n()) %>% xtable(.) %>% print(.,type = "html", include.rownames = FALSE)
```
```{r histPerpub, eval = TRUE, echo = TRUE, warning = FALSE, error = FALSE, message = FALSE, results="asis", fig.height = 10}
sampleSize.df <- NHTS.list$perpub %>% group_by(location) %>% summarise(n = n())

sampleSize.df <- within(sampleSize.df, location <- factor(location, levels = sampleSize.df$location[order(sampleSize.df$n)]))

sampleSize.df %>% ggplot(aes(x = location, y = n, fill = location)) + geom_bar(stat = "identity") + theme_bw() + labs(x = "", y = "", title = "Sample Size by State", subtitle = "NHTS 2017") + coord_flip() + theme(legend.position = "none") + scale_y_continuous(trans='log10')
```
### Mode Share
```{r modeShare, eval = TRUE, echo = TRUE, warning = FALSE, error = FALSE, message = FALSE, results="asis", fig.width = 8}
modeShare.df <- NHTS.list$NHTS.df %>% group_by(mode) %>% summarise(duration = sum(duration))

modeShare.df <- within(modeShare.df, mode <- factor(mode, levels = modeShare.df$mode[order(modeShare.df$duration)]))

modeShare.df %>% ggplot(aes(x=mode, y = duration, fill = mode)) + geom_bar(stat = "identity") + theme_bw() + labs(x = "", y = "", title = "Total Minutes Traveled by Mode (Urban and Rural)", subtitle = "NHTS 2017") + theme(legend.position="none") + coord_flip() + scale_y_continuous(trans='log10')
```
### Proportion of Households That Never Walk or Bike (Urban & Metro)
```{r neverWalk, eval = TRUE, echo = TRUE, warning = FALSE, error = FALSE, message = FALSE, results="asis", fig.width = 8}
p0.df <- NHTS.list$hhpub %>% filter(!is.na(HH_CBSA) & URBRUR == "urban") %>% group_by(HH_CBSA) %>% summarise(p0 = sum(WALK == "never" & BIKE == "never", na.rm = TRUE)/sum(!is.na(WALK) & !is.na(BIKE)))

orderedLevels <- p0.df$HH_CBSA[order(p0.df$p0)]
p0.df <- within(p0.df, HH_CBSA <- factor(HH_CBSA, level = orderedLevels))

p0.df %>% ggplot(aes(x=HH_CBSA, y = p0, fill = HH_CBSA)) + geom_bar(stat="identity", position = "dodge") + theme_bw() + labs(x = "", y = "", title = "Proportion of Households That Never Walk or Bike", subtitle = "NHTS 2017 (Urban w/ Pop. > 1 million)") + theme(legend.position="none") + coord_flip()
```
